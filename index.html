<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ActiveData Code Coverage Query Tool</title>
    <script src="lib/jquery.js"></script>
    <script src="modevlib/imports/import.js"></script>
    <script src="common.js"></script>
    <script src="query1.js"></script>
    <script src="query2.js"></script>
    <script src="query3.js"></script>
    <link type="text/css" rel="stylesheet" href="css/menu.css"/>
</head>
<body>
    <div id="mainContent" style="width:80%; margin: 0 auto;">
        <h2>ActiveData Code Coverage Query Tool</h2>
        <p id="selectBuildRevisionLabel">Select a build revision</p>
        <select id="selectBuildRevision"></select>
        <br><br>

        <p>Select a query:</p>
        <select id="querySelect"></select>
        <br><br>

        <div id="step2" style="display: none">
            <p id="selectLabel2"></p>
            <select id="select2"></select>
            <br><br>

            <p id="permalink"></p>
            <br>
            <p id="resultDesc"></p>
            <div id="resultTable">
                <table>
                    <tbody id="resultTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="application/javascript">

        var search = function*(query){
            var output = yield (Rest.post({
                url: "https://activedata.allizom.org/query",
                json: query
            }));
            yield (output);
        };

        // add the list of builds
        addBuild();

        // populate the query select
        var queryList = {
            0: "",
            1: "Given a test, which files does it touch?",
            2: "Given a test, which unique files does it touch?",
            3: "Given a source file, which tests touch it?",
            4: "Given a patch (list of source files and methods adjusted) recommend which tests I should run."
        };

        for (var key in queryList) {
            if (!queryList.hasOwnProperty(key)) continue;
            $("#querySelect").append("<option value='" + key + "'>" + queryList[key] + "</option>");
        }

        $("#querySelect").on('change', function (e) {
            if (this.value == "0") {
                $("#step2").hide();
            }
            else {
                $("#step2").show();
                processQuery(this.value);
            }
        });

        // use the query parameters if needed
        var buildRevision = getParameterByName("buildRevision");
        var query = getParameterByName("query");
        var select2 = getParameterByName("select2");

        if (buildRevision) {
            $("#selectBuildRevision").val(buildRevision);
        }

        if (query) {
            $("#querySelect").val(query);
        }

        if (select2) {
            $("#select2").val(select2);
        }

        if (query && select2) {
            var param = {
                "buildRevision": buildRevision,
                "select2": select2
            };
            $("#step2").show();
            processQuery(query, param, true);
        }

</script>
</body>
</html>